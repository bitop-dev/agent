# .gitlab-ci.yml â€” AI-powered CI pipeline using bitop-dev/agent
#
# Covers three jobs:
#   ai:mr-review      â€” post an AI code review on every merge request
#   ai:release-notes  â€” generate release notes when a tag is pushed
#   ai:nightly-check  â€” scheduled health check (run via GitLab Schedules)
#
# Setup:
#   1. Add CI/CD Variables (Settings â†’ CI/CD â†’ Variables):
#        ANTHROPIC_API_KEY   â€” your LLM provider key  (Protected + Masked)
#        GITLAB_API_TOKEN    â€” project access token with api scope (for MR notes)
#   2. For nightly-check: create a Pipeline Schedule (CI/CD â†’ Schedules)
#      with variable NIGHTLY=true on a cron like "0 2 * * *"

# â”€â”€ Shared config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
default:
  interruptible: true

variables:
  AGENT_VERSION: latest   # pin to e.g. v0.1.0 for reproducibility

# â”€â”€ Helper: install agent binary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.install_agent: &install_agent
  - |
    echo "Installing agent ${AGENT_VERSION}..."
    curl -sSL "https://github.com/bitop-dev/agent/releases/latest/download/agent_latest_linux_amd64.tar.gz" \
      | tar -xz -C /usr/local/bin/
    agent --help > /dev/null && echo "agent installed"

# â”€â”€ Helper: write base config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.write_config: &write_config
  - |
    cat > /tmp/agent.yaml << 'AGENTEOF'
    provider: anthropic
    model: claude-sonnet-4-5
    api_key: ${ANTHROPIC_API_KEY}
    max_tokens: 4096
    max_turns: 15
    auto_approve: true
    tools:
      preset: readonly
      work_dir: .
    AGENTEOF

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# JOB 1: AI Merge Request Review
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ai:mr-review:
  stage: test
  image: ubuntu:24.04

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

  before_script:
    - apt-get update -qq && apt-get install -y -qq curl git jq
    - *install_agent
    - *write_config

  script:
    - |
      echo "Fetching diff for MR !${CI_MERGE_REQUEST_IID}..."

      # Get the diff via git (base branch vs current HEAD)
      git fetch origin "${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}"
      git diff "origin/${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}...HEAD" \
        -- '*.go' '*.yaml' '*.yml' '*.md' \
        > /tmp/mr.diff

      LINES=$(wc -l < /tmp/mr.diff)
      echo "Diff: ${LINES} lines"

      if [[ "$LINES" -eq 0 ]]; then
        echo "No relevant changes â€” skipping review"
        exit 0
      fi

    - |
      echo "Running AI review..."
      REVIEW=$(agent -config /tmp/agent.yaml -prompt "
      Review this merge request diff. Focus on:
      - Correctness and logic errors
      - Security vulnerabilities or unsafe patterns
      - Missing or inadequate error handling
      - Test coverage gaps for new code
      - Performance concerns

      Be concise. Use bullet points grouped by file.
      If the changes look good, say: âœ… LGTM â€” no significant issues found.

      Diff:
      $(cat /tmp/mr.diff)
      ")
      echo "$REVIEW" > /tmp/review.txt

    - |
      echo "Posting review to MR !${CI_MERGE_REQUEST_IID}..."

      # Delete previous bot notes to avoid duplicates
      NOTES=$(curl -sSf \
        --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes")

      echo "$NOTES" | jq -r '.[] | select(.author.username == "gitlab-ci-token" or (.body | startswith("## ðŸ¤–"))) | .id' \
      | while read -r NOTE_ID; do
          curl -sSf -X DELETE \
            --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
            "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes/${NOTE_ID}" \
            && echo "Deleted old note ${NOTE_ID}"
        done

      # Post the new review
      BODY="## ðŸ¤– AI Code Review

$(cat /tmp/review.txt)

---
_Generated by [bitop-dev/agent](https://github.com/bitop-dev/agent)_"

      curl -sSf -X POST \
        --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "$(jq -n --arg body "$BODY" '{"body": $body}')" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes"

      echo "Review posted."

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# JOB 2: AI Release Notes
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ai:release-notes:
  stage: deploy
  image: ubuntu:24.04

  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

  before_script:
    - apt-get update -qq && apt-get install -y -qq curl git jq
    - *install_agent
    - |
      cat > /tmp/agent.yaml << 'AGENTEOF'
      provider: anthropic
      model: claude-sonnet-4-5
      api_key: ${ANTHROPIC_API_KEY}
      max_tokens: 2048
      max_turns: 5
      auto_approve: true
      tools:
        preset: none
      AGENTEOF

  script:
    - |
      CURRENT_TAG="${CI_COMMIT_TAG}"
      PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")

      if [[ -n "$PREV_TAG" ]]; then
        echo "Generating notes: ${PREV_TAG}..${CURRENT_TAG}"
        COMMITS=$(git log "${PREV_TAG}..${CURRENT_TAG}" --oneline --no-merges)
      else
        echo "No previous tag â€” using last 30 commits"
        COMMITS=$(git log --oneline --no-merges -30)
      fi

      echo "$COMMITS" > /tmp/commits.txt
      echo "Found $(wc -l < /tmp/commits.txt) commits"

    - |
      agent -config /tmp/agent.yaml -prompt "
      Write GitLab release notes for version ${CI_COMMIT_TAG}.

      Commits:
      $(cat /tmp/commits.txt)

      Rules:
      - Use Markdown
      - Group into: ## âœ¨ Features, ## ðŸ› Bug Fixes, ## ðŸ”§ Other Changes
      - Skip commits starting with: chore, test, docs, ci, Merge
      - Each bullet point should be user-facing and action-oriented
      - Start with a one-sentence release summary
      - Be concise
      " > /tmp/release-notes.md

      echo "Generated release notes:"
      cat /tmp/release-notes.md

    - |
      # Create or update the GitLab Release
      DESCRIPTION=$(cat /tmp/release-notes.md)

      # Check if release exists
      STATUS=$(curl -so /dev/null -w "%{http_code}" \
        --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${CI_COMMIT_TAG}")

      if [[ "$STATUS" == "200" ]]; then
        echo "Updating existing release..."
        curl -sSf -X PUT \
          --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "$(jq -n --arg desc "$DESCRIPTION" '{"description": $desc}')" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${CI_COMMIT_TAG}"
      else
        echo "Creating new release..."
        curl -sSf -X POST \
          --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "$(jq -n \
            --arg tag "${CI_COMMIT_TAG}" \
            --arg name "Release ${CI_COMMIT_TAG}" \
            --arg desc "$DESCRIPTION" \
            '{"tag_name": $tag, "name": $name, "description": $desc}')" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
      fi

      echo "Release ${CI_COMMIT_TAG} published."

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# JOB 3: Nightly Health Check (run via GitLab Pipeline Schedule)
#
# Set up: CI/CD â†’ Schedules â†’ New schedule
#   Cron: 0 2 * * *
#   Variable: NIGHTLY = "true"
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ai:nightly-check:
  stage: test
  image: ubuntu:24.04

  rules:
    - if: $NIGHTLY == "true"

  before_script:
    - apt-get update -qq && apt-get install -y -qq curl git golang-go jq
    - *install_agent
    - |
      cat > /tmp/agent.yaml << 'AGENTEOF'
      provider: anthropic
      model: claude-sonnet-4-5
      api_key: ${ANTHROPIC_API_KEY}
      max_tokens: 4096
      max_turns: 10
      auto_approve: true
      tools:
        preset: readonly
        work_dir: .
      AGENTEOF

  script:
    - |
      echo "Running nightly health checks..."
      {
        echo "=== go vet ==="
        go vet ./... 2>&1 || true

        echo ""
        echo "=== go test ==="
        go test -timeout 120s ./... 2>&1 || true

        echo ""
        echo "=== go mod tidy check ==="
        cp go.sum go.sum.bak
        go mod tidy 2>&1 || true
        diff go.sum go.sum.bak && echo "go.sum is clean" || echo "WARN: go.sum is dirty"
        mv go.sum.bak go.sum
      } > /tmp/check-output.txt 2>&1

      echo "Raw output:"
      cat /tmp/check-output.txt

    - |
      echo "Asking agent to summarise..."
      agent -config /tmp/agent.yaml -prompt "
      Analyse this nightly CI output from a Go repository.

      $(cat /tmp/check-output.txt)

      Respond with:
        STATUS: HEALTHY
        or
        STATUS: FAILED

      Then a blank line, then a concise summary:
      - What passed
      - What failed (with file/line if available)
      - Recommended fix for each failure
      " > /tmp/report.txt

      echo "Report:"
      cat /tmp/report.txt

    - |
      if grep -q "STATUS: FAILED" /tmp/report.txt; then
        echo "Health check FAILED â€” creating GitLab issue..."

        DATE=$(date +%Y-%m-%d)
        BODY=$(cat /tmp/report.txt)

        curl -sSf -X POST \
          --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "$(jq -n \
            --arg title "Nightly check failed â€” ${DATE}" \
            --arg desc "$BODY" \
            '{"title": $title, "description": $desc, "labels": "automated,bug"}')" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues"

        echo "Issue created."
        exit 1
      else
        echo "All checks passed âœ…"
      fi

  artifacts:
    when: always
    paths:
      - /tmp/check-output.txt
      - /tmp/report.txt
    expire_in: 7 days
